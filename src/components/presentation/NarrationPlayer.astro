---
/**
 * NarrationPlayer.astro
 *
 * Audio player with caption support for presentation slides.
 *
 * Features:
 * - Auto-plays narration for current slide
 * - Toggle captions with 'C' key
 * - Shows timed captions synced to audio
 * - Falls back to full text if no caption timing
 *
 * Props:
 * - classNumber: number - The class number (for audio path)
 * - narration: object - The narration data from narration.json
 */

interface Props {
  classNumber: number;
  narration: {
    slides: Record<string, {
      ssml: string;
      plainText: string;
      estimatedDuration: number | null;
      captions?: Array<{ start: number; end: number; text: string }>;
    }>;
  };
}

const { classNumber, narration } = Astro.props;
---

<div id="narration-player" class="narration-player" data-class={classNumber}>
  <audio id="narration-audio" preload="auto"></audio>

  <div id="caption-container" class="caption-container" aria-live="polite" hidden>
    <div id="caption-text" class="caption-text"></div>
  </div>

  <div id="narration-controls" class="narration-controls">
    <button id="play-pause-btn" class="control-btn" aria-label="Play/Pause narration">
      <span class="play-icon">▶</span>
      <span class="pause-icon" hidden>⏸</span>
    </button>
    <button id="caption-toggle-btn" class="control-btn" aria-label="Toggle captions (C)">
      CC
    </button>
    <div id="narration-progress" class="progress-bar">
      <div id="narration-progress-fill" class="progress-fill"></div>
    </div>
  </div>
</div>

<script define:vars={{ narration, classNumber }}>
  // Store narration data globally for this presentation
  window.NARRATION_DATA = narration;
  window.NARRATION_CLASS = classNumber;
</script>

<script>
  class NarrationController {
    constructor() {
      this.audio = document.getElementById('narration-audio');
      this.captionContainer = document.getElementById('caption-container');
      this.captionText = document.getElementById('caption-text');
      this.playPauseBtn = document.getElementById('play-pause-btn');
      this.captionToggleBtn = document.getElementById('caption-toggle-btn');
      this.progressBar = document.getElementById('narration-progress');
      this.progressFill = document.getElementById('narration-progress-fill');

      this.narration = window.NARRATION_DATA;
      this.classNumber = window.NARRATION_CLASS;
      this.currentSlide = 1;
      this.captionsEnabled = false;
      this.captionInterval = null;

      this.init();
    }

    init() {
      // Event listeners
      this.playPauseBtn?.addEventListener('click', () => this.togglePlayPause());
      this.captionToggleBtn?.addEventListener('click', () => this.toggleCaptions());

      this.audio?.addEventListener('timeupdate', () => this.updateProgress());
      this.audio?.addEventListener('ended', () => this.onEnded());
      this.audio?.addEventListener('play', () => this.onPlay());
      this.audio?.addEventListener('pause', () => this.onPause());

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => this.handleKeydown(e));

      // Listen for slide changes
      window.addEventListener('slidechange', (e) => {
        this.loadSlide(e.detail.slideNumber);
      });

      // Load saved caption preference
      this.captionsEnabled = localStorage.getItem('captionsEnabled') === 'true';
      this.updateCaptionUI();
    }

    loadSlide(slideNumber) {
      this.currentSlide = slideNumber;
      const slideData = this.narration?.slides?.[String(slideNumber)];

      if (!slideData) {
        console.log(`No narration for slide ${slideNumber}`);
        this.audio.src = '';
        this.captionText.textContent = '';
        return;
      }

      // Load audio
      const audioPath = `/audio/class-${this.classNumber}/slide-${slideNumber}.mp3`;
      this.audio.src = audioPath;

      // Set caption text (will be updated during playback if timed captions exist)
      if (!slideData.captions || slideData.captions.length === 0) {
        this.captionText.textContent = slideData.plainText;
      } else {
        this.captionText.textContent = '';
      }

      // Reset progress
      this.progressFill.style.width = '0%';
    }

    togglePlayPause() {
      if (this.audio.paused) {
        this.audio.play().catch(e => console.error('Playback failed:', e));
      } else {
        this.audio.pause();
      }
    }

    toggleCaptions() {
      this.captionsEnabled = !this.captionsEnabled;
      localStorage.setItem('captionsEnabled', String(this.captionsEnabled));
      this.updateCaptionUI();
    }

    updateCaptionUI() {
      if (this.captionsEnabled) {
        this.captionContainer.hidden = false;
        this.captionToggleBtn.classList.add('active');
      } else {
        this.captionContainer.hidden = true;
        this.captionToggleBtn.classList.remove('active');
      }
    }

    updateProgress() {
      if (this.audio.duration) {
        const percent = (this.audio.currentTime / this.audio.duration) * 100;
        this.progressFill.style.width = `${percent}%`;

        // Update timed captions
        this.updateTimedCaptions();
      }
    }

    updateTimedCaptions() {
      const slideData = this.narration?.slides?.[String(this.currentSlide)];
      if (!slideData?.captions || slideData.captions.length === 0) return;

      const currentTime = this.audio.currentTime;
      const currentCaption = slideData.captions.find(
        c => currentTime >= c.start && currentTime < c.end
      );

      if (currentCaption) {
        this.captionText.textContent = currentCaption.text;
      }
    }

    onPlay() {
      this.playPauseBtn.querySelector('.play-icon').hidden = true;
      this.playPauseBtn.querySelector('.pause-icon').hidden = false;
    }

    onPause() {
      this.playPauseBtn.querySelector('.play-icon').hidden = false;
      this.playPauseBtn.querySelector('.pause-icon').hidden = true;
    }

    onEnded() {
      this.onPause();
      this.progressFill.style.width = '100%';
    }

    handleKeydown(e) {
      // Don't capture if user is typing in an input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      switch (e.key.toLowerCase()) {
        case 'c':
          e.preventDefault();
          this.toggleCaptions();
          break;
        case ' ':
          // Only handle space if not in fullscreen presentation mode
          // (let presentation.js handle it for slide navigation)
          if (e.shiftKey) {
            e.preventDefault();
            this.togglePlayPause();
          }
          break;
        case 'n':
          // Play narration for current slide
          if (e.shiftKey) {
            e.preventDefault();
            this.audio.currentTime = 0;
            this.audio.play();
          }
          break;
      }
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    window.narrationController = new NarrationController();
  });
</script>

<style>
  .narration-player {
    position: fixed;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
  }

  .caption-container {
    background: rgba(0, 0, 0, 0.85);
    color: white;
    padding: 1rem 2rem;
    border-radius: 8px;
    max-width: 80vw;
    margin-bottom: 1rem;
    text-align: center;
  }

  .caption-text {
    font-size: 1.5rem;
    line-height: 1.4;
    font-family: var(--font-body, system-ui, sans-serif);
  }

  .narration-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(0, 0, 0, 0.7);
    padding: 0.5rem 1rem;
    border-radius: 24px;
  }

  .control-btn {
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .control-btn:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .control-btn.active {
    background: rgba(255, 255, 255, 0.3);
  }

  .progress-bar {
    width: 150px;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: white;
    width: 0%;
    transition: width 0.1s linear;
  }

  /* Hide when no narration */
  .narration-player:not([data-has-audio]) .narration-controls {
    opacity: 0.5;
    pointer-events: none;
  }

  @media (max-width: 768px) {
    .caption-text {
      font-size: 1.25rem;
    }

    .narration-player {
      bottom: 80px;
    }
  }
</style>
